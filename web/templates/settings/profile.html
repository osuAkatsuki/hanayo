{{/* prettier-ignore-start */}}
{{/*###
Handler=/settings
TitleBar=Settings
BannerContent=settings2.jpg
BannerType=1
Include=menu.html
MinPrivileges=2
*/}}
{{/* prettier-ignore-end */}}
{{ define "tpl" }}
  <div class="ui container">
    <div class="ui stackable grid">
      {{ template "settingsSidebar" . }}
      <div class="twelve wide column">
        <div class="ui segment">
          <form class="ui form" method="post">
            {{ $d := .Get "users/self/settings" }}
            <h3 class="ui header">{{ .T "General" }}</h3>
            <div class="field">
              <label>
                <a href="/settings/username">{{ .T "Username" }}</a>
              </label>
              <input
                type="text"
                value="{{ .Context.User.Username }}"
                disabled />
            </div>
            <div class="field">
              <label>
                <a href="/settings/password">{{ .T "Email address" }}</a>
              </label>
              <input
                type="email"
                value="{{ $d.email }}"
                placeholder="{{ .T "Email address" }}"
                required
                disabled />
            </div>
            {{ if has .Context.User.Privileges 8388608 }}
              <div class="field">
                <label>
                  {{ .T "Leaderboard size (In-Game)" }}
                </label>
                <input
                  type="number"
                  name="leaderboard_size"
                  id="lbSizeInput"
                  value="{{ $d.leaderboard_size }}"
                  oninput="validateLeaderboardSizeInput()"
                  placeholder="1-1000" />
              </div>
            {{ end }}
            <div class="field">
              <label>{{ .T "Favourite mode" }}</label>
              <select class="ui dropdown" name="favourite_mode" data-cast="int">
                {{ range $k, $v := modes }}
                  <option
                    value="{{ $k }}"
                    {{ if eq (int $d.favourite_mode) $k }}selected{{ end }}>
                    {{ $v }}
                  </option>
                {{ end }}
              </select>
            </div>
            <div class="field">
              <label>{{ .T "User Title" }}</label>
              <select class="ui dropdown" name="user_title">
                <option value="">{{ .T "No title" }}</option>
                {{ range $d.eligible_titles }}
                  <option
                    value="{{ .id }}"
                    {{ if eq $d.user_title.id .id }}selected{{ end }}>
                    {{ .title }}
                  </option>
                {{ end }}
              </select>
            </div>
            <div class="field">
              <div class="ui toggle checkbox">
                <input
                  type="checkbox"
                  name="vanilla_pp_leaderboards"
                  {{ if $d.vanilla_pp_leaderboards }}checked{{ end }} />
                <label
                  title="{{ .T "Enabling this will display PP leaderboards for vanilla game modes." }}">
                  {{ .T "Vanilla PP Leaderboards" }}
                </label>
              </div>
            </div>
            {{ if has .Context.User.Privileges 4 }}
              <h3 class="ui header">{{ .T "Custom badge" }}</h3>
              <div class="ui warning message badge">
                {{ .T "<b>Do not use offensive badges and do not pretend to be someone else with your badge.</b> If you abuse the badges system, you'll be silenced and you won't be able to edit your custom badge anymore." | html }}
              </div>
              <div class="ui toggle checkbox">
                <input
                  type="checkbox"
                  name="custom_badge.show"
                  {{ if $d.custom_badge.show }}checked{{ end }} />
                <label>{{ .T "Enable" }}</label>
              </div>
              <div
                id="custom-badge-fields"
                {{ if not $d.custom_badge.show }}style="display: none"{{ end }}
                class="little top margin">
                <p>
                  <a href="http://semantic-ui.com/elements/icon.html">
                    {{ .T "Icon reference" }}
                  </a>
                </p>
                <div
                  class="ui two column center aligned grid"
                  style="margin-top: 0">
                  <div class="column">
                    <i
                      class="circular {{ $d.custom_badge.icon }} big icon"
                      id="badge-icon"
                      style="justify-content: center;display: inline-flex;"></i>
                    <br />
                    <b id="badge-name">{{ $d.custom_badge.name }}</b>
                  </div>
                  <div class="column">
                    <p>
                      <input
                        type="text"
                        name="custom_badge.icon"
                        placeholder="plane, left chevron, hand spock..."
                        value="{{ $d.custom_badge.icon }}" />
                    </p>
                    <p>
                      <input
                        type="text"
                        name="custom_badge.name"
                        placeholder="{{ .T "Dinosaur, oompa-loompa, cool guy..." }}"
                        value="{{ $d.custom_badge.name }}" />
                    </p>
                  </div>
                </div>
              </div>
            {{ end }}
            <h3 class="ui header">{{ .T "Playstyle" }}</h3>
            <div class="ui three column grid" id="checkbox-grid">
              {{ $ := . }}
              {{ range $k, $v := styles }}
                <div class="column">
                  {{ $checked := band (int $d.play_style) (shift 1 $k) }}
                  <div class="ui checkbox">
                    <input
                      type="checkbox"
                      data-sv="{{ shift 1 $k }}"
                      {{ if $checked }}checked{{ end }} />
                    <label>{{ $.T $v }}</label>
                  </div>
                </div>
              {{ end }}
            </div>
            <!--h3 class="ui header">{{ .T "Preferences" }}</h3><br>
					<div class="ui three column grid" id="checkbox-grid">
					<div class="ui checkbox">
						{{ $checked := band (int $d.prefer_relax) }}
						<input type="checkbox" data-sv="{{ if $checked }}
              1
            {{ else }}
              0
            {{ end }}" {{ if $checked }}checked{{ end }}>
							<label>b</label>
						</div>

					</div-->
            <br />
            <div class="ui divider"></div>
            <div style="text-align: right">
              <button id="submitSettingsButton" type="submit" class="ui blue button">
                {{ .T "Save" }}
              </button>
            </div>
            {{ ieForm .Gin }}
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
    function checkInputFromAPI() {
      const leaderboardInputEl = document.getElementById("lbSizeInput");
      if (isNaN(leaderboardInputEl.valueAsNumber)) {
        leaderboardInputEl.value = "{{ .Conf.APP_DEFAULT_LEADERBOARD_SIZE_SETTING }}";
      }
    }

    function validateLeaderboardSizeInput() {
      const leaderboardInputEl = document.getElementById("lbSizeInput");
      if (isNaN(leaderboardInputEl.valueAsNumber)) {
        leaderboardInputEl.value = "";
      }

      if (leaderboardInputEl.valueAsNumber > 1000) {
        leaderboardInputEl.value = "1000";
      }

      if (leaderboardInputEl.valueAsNumber < 1) {
        leaderboardInputEl.value = "1";
      }
    }

    $(document).ready(function () {
      checkInputFromAPI();

      $("input[name='custom_badge.icon']").on("input", function () {
        $("#badge-icon").attr(
          "class",
          "circular big icon " + escapeHTML($(this).val())
        );
      });
      $("input[name='custom_badge.name']").on("input", function () {
        $("#badge-name").html(escapeHTML($(this).val()));
      });
      $("input[name='custom_badge.show']").change(function () {
        if ($(this).is(":checked")) $("#custom-badge-fields").slideDown();
        else $("#custom-badge-fields").slideUp();
      });
      var isDark = $("#dark-site").is(":checked");
      $("form").submit(function (e) {
        e.preventDefault();

        var darkSetting = $("#dark-site").is(":checked");
        if (darkSetting != isDark) {
          var cflags = document.cookie.replace(
            /(?:(?:^|.*;\s*)cflags\s*\=\s*([^;]*).*$)|^.*$/,
            "$1"
          );
          cflags = darkSetting ? +cflags | 1 : +cflags & ~1;
          document.cookie = "cflags=" + cflags + ";path=/;max-age=31536000";
        }

        var obj = formToObject($(this));
        var ps = 0;
        $(this)
          .find("input[data-sv]")
          .each(function (_, el) {
            el = $(el);
            if (el.is(":checked")) {
              ps |= el.data("sv");
            }
          });
        obj.leaderboard_size = obj.leaderboard_size !== "" ? parseInt(obj.leaderboard_size) : hanayoConf.defaultLeaderboardSize
        obj.play_style = ps;
        var f = $(this);
        api(
          "users/self/settings",
          obj,
          function (data) {
            if (darkSetting != isDark) {
              window.location.reload();
              return;
            }
            showMessage("success", "Your new settings have been saved.");
            f.removeClass("loading");
          },
          true
        );
        return false;
      });
    })
  </script>
{{ end }}
